/*
 * Copyright (C) 2005-2006 Micronas USA Inc.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License (Version 2) as
 * published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 */

#include <linux/module.h>
#include <linux/init.h>
#include <linux/i2c.h>
#include <linux/ioctl.h>
#include <linux/slab.h>
#include <linux/miscdevice.h>
#include <linux/fcntl.h>
#include <linux/init.h>
#include <linux/device.h>
#include <linux/uaccess.h>

#define DEVICE_NAME "tw8836"
#define DEVICE_NUM 1

#define TW8836_REG_AUTOGAIN		0x02
#define TW8836_REG_HUE			0x0f
#define TW8836_REG_SATURATION		0x10
#define TW8836_REG_CONTRAST		0x11
#define TW8836_REG_BRIGHTNESS		0x12
#define TW8836_REG_COLOR_KILLER		0x14
#define TW8836_REG_GAIN			0x3c
#define TW8836_REG_CHROMA_GAIN		0x3d
#define TW8836_REG_BLUE_BALANCE		0x3e
#define TW8836_REG_RED_BALANCE		0x3f

//struct tw8836 {
//	struct class *tw8836_class;
//	struct device *tw8836_device;
//	unsigned int tw8836_major
//};

//struct tw8836 tw8836;

unsigned char tw8836_lvds_to_bt656[] =
{
	/* Page 00 */
	0xFF, 0x00,
	0x02, 0x48,
	0x03, 0xFE,
	0x04, 0x01,
	0x06, 0x06,
	0x07, 0x08,
	0x08, 0x86,
	0x0F, 0x00,
	0x1F, 0x00,
	0x40, 0x05,
	0x41, 0x10,
	0x42, 0x25,
	0x43, 0x15,
	0x44, 0xD0,
	0x45, 0x82,
	0x46, 0x00,
	0x47, 0x20,
	0x48, 0x00,
	0x4B, 0x00,
	0x50, 0x00,
	0x51, 0x08,
	0x52, 0x02,
	0x53, 0x00,
	0x54, 0x00,
	0x55, 0x00,
	0x56, 0x00,
	0x57, 0x00,
	0x5F, 0x00,
	0x60, 0x00,
	0x62, 0x10,
	0x63, 0x00,
	0x64, 0x04,
	0x65, 0x00,
	0x66, 0x30,
	0x67, 0x63,
	0x68, 0x01,
	0x69, 0x25,
	0x6A, 0x09,
	0x6B, 0xD0,
	0x6C, 0x05,
	0x6D, 0x00,
	0x6E, 0x10,
	0x6F, 0x10,
	0x77, 0x02,
	0x78, 0x00,
	0x79, 0x00,
	0x7A, 0x00,
	0x7B, 0x28,
	0x7C, 0x05,
	0x7D, 0x00,
	0x7E, 0x00,
	0x7F, 0x80,
	0xD4, 0x00,
	0xE7, 0x16,
	0xE8, 0x01,
	0xE9, 0x55,
	0xEA, 0x55,
	0xEB, 0x40,
	0xEC, 0x30,
	0xED, 0x24,
	0xF6, 0x00,
	0xF7, 0x16,
	0xF8, 0x01,
	0xF9, 0xED,
	0xFA, 0x0A,
	0xFB, 0x40,
	0xFC, 0x30,
	0xFD, 0x23,

	/* Page 01 */
	0xFF, 0x01,
	0x02, 0x6E,
	0x04, 0x00,
	0x05, 0x11,
	0x06, 0x00,
	0x07, 0x02,
	0x08, 0x15,
	0x09, 0xF0,
	0x0A, 0x0B,
	0x0B, 0xD0,
	0x0C, 0xCC,
	0x0D, 0x00,
	0x10, 0x00,
	0x11, 0x5C,
	0x12, 0x11,
	0x13, 0x80,
	0x14, 0x80,
	0x15, 0x00,
	0x17, 0x30,
	0x18, 0x44,
	0x1A, 0x10,
	0x1B, 0x00,
	0x1C, 0x27,
	0x1D, 0x7F,
	0x1E, 0x00,
	0x1F, 0x00,
	0x20, 0x50,
	0x21, 0x22,
	0x22, 0xF0,
	0x23, 0xD8,
	0x24, 0xBC,
	0x25, 0xB8,
	0x26, 0x44,
	0x27, 0x38,
	0x28, 0x00,
	0x29, 0x00,
	0x2A, 0x78,
	0x2B, 0x44,
	0x2C, 0x30,
	0x2D, 0x14,
	0x2E, 0xA5,
	0x2F, 0xE0,
	0x30, 0xC0,
	0x31, 0x00,
	0x32, 0x00,
	0x33, 0x05,
	0x34, 0x1A,
	0x35, 0x00,
	0x36, 0xE3,
	0x37, 0x28,
	0x38, 0xAF,
	0x40, 0x00,
	0x41, 0x80,
	0x42, 0x00,
	0xC0, 0x38,
	0xC1, 0xC7,
	0xC2, 0xE2,
	0xC3, 0x06,
	0xC4, 0x67,
	0xC5, 0x09,
	0xC6, 0x27,
	0xC7, 0x04,
	0xC8, 0x00,
	0xC9, 0x00,
	0xCA, 0x00,
	0xCB, 0x56,
	0xCC, 0x18,
	0xCD, 0x54,
	0xD0, 0x07,
	0xD1, 0x10,
	0xD2, 0x10,
	0xD3, 0x10,
	0xD4, 0x27,
	0xD5, 0x00,
	0xD6, 0x10,
	0xD7, 0x26,
	0xD8, 0x00,
	0xD9, 0x02,
	0xDA, 0x80,
	0xDB, 0x80,
	0xDC, 0x10,
	0xE0, 0x00,
	0xE1, 0x05,
	0xE2, 0xD9,
	0xE3, 0x17,
	0xE4, 0x34,
	0xE5, 0x3B,
	0xE6, 0x20,
	0xE7, 0x2A,
	0xE8, 0x2E,
	0xE9, 0x00,
	0xEA, 0x03,
	0xF6, 0xB0,
	0xF7, 0x00,
	0xF8, 0x00,
	0xF9, 0x00,
	0xFA, 0x38,

	/* Page 02 */
	0xFF, 0x02,
	0x01, 0x00,
	0x02, 0x20,
	0x03, 0x00,
	0x04, 0x20,
	0x05, 0x00,
	0x06, 0x20,
	0x07, 0x40,
	0x08, 0x20,
	0x09, 0x00,
	0x0A, 0x04,
	0x0B, 0x10,
	0x0C, 0x00,
	0x0D, 0x81,
	0x0E, 0x50,
	0x0F, 0x02,
	0x10, 0x30,
	0x11, 0x00,
	0x12, 0x05,
	0x13, 0x00,
	0x14, 0x0A,
	0x15, 0x0F,
	0x16, 0xD0,
	0x17, 0x02,
	0x18, 0x00,
	0x19, 0x0C,
	0x1A, 0x00,
	0x1B, 0x00,
	0x1C, 0x32,
	0x1D, 0x21,
	0x1E, 0x02,
	0x20, 0x00,
	0x21, 0x00,
	0x40, 0x10,
	0x41, 0x00,
	0x42, 0x05,
	0x43, 0x01,
	0x44, 0x64,
	0x45, 0xF4,
	0x46, 0x00,
	0x47, 0x0A,
	0x48, 0x36,
	0x49, 0x10,
	0x4A, 0x00,
	0x4B, 0x00,
	0x4C, 0x00,
	0x4D, 0x44,
	0x4E, 0x04,
	0xE4, 0x21,
	0xF8, 0x00,
	0xF9, 0x80,

	/* Page 04,*/
	0xFF, 0x04,
	0xC0, 0x03,
	0xC1, 0x60,
	0xC2, 0x00,
	0xC3, 0xC6,
	0xC4, 0x84,
	0xC5, 0x80,
	0xC6, 0x00,
	0xC7, 0x00,
	0xC8, 0x00,
	0xC9, 0x6C,
	0xCA, 0x6B,
	0xCB, 0x00,
	0xCC, 0x04,
	0xCD, 0x00,
	0xCE, 0x00,
	0xCF, 0x1F,
	0xD0, 0x40,
	0xD1, 0x20,
	0xD2, 0x19,
	0xD3, 0x00,
	0xD4, 0x00,
	0xD5, 0x00,
	0xD6, 0x00,
	0xD7, 0x00,
	0xD8, 0x05,
	0xD9, 0x08,
	0xDA, 0x00,
	0xDB, 0x00,
	0xDC, 0x00,
	0xDD, 0x6D,
	0xDE, 0x00,
	0xDF, 0x00,
	0xE0, 0x00,
	0xE1, 0x20,
	0xE2, 0x69,
	0xE3, 0x78,
	0xE4, 0x01,
	0xE5, 0x0E,
	0xE6, 0x00,
	0xE7, 0x1B,
	0xE8, 0x00,
	0xE9, 0x0C,
	0xEA, 0x00,
	0xEB, 0x90,
	0xF0, 0x00,
	0xF1, 0x00,
	0xF2, 0x00,
	0xF3, 0x40,
	0xF4, 0x80,
	0xF5, 0x00,
	0xF6, 0x04,
	0xF7, 0x90,
	0xF8, 0x00,
	0xF9, 0x00,
	0xFA, 0x00,
	0xFB, 0x00,
	0xFC, 0x00,
	0xFD, 0x00,
	0xFE, 0x00,

	/* Page 06 */
	0xFF, 0x06,
	0x40, 0x00,
	0x41, 0x00,
	0x42, 0x00,
	0x43, 0x00,
	0x44, 0x00,
	0x46, 0x00,
	0x48, 0x07,
	0x49, 0x01,
	0x4A, 0x00,
	0x4B, 0x30,
	0x4C, 0x40,
	0x4D, 0x17,
	0x4E, 0x00,
};


static int write_reg(struct i2c_client *client, u8 reg, u8 value)
{
	return i2c_smbus_write_byte_data(client, reg, value);
}

static int write_regs(struct i2c_client *client, const u8 *regs, int count)
{
	int ret;
	int i;

	for (i = 0; i <  count; i += 2) {
		ret = i2c_smbus_write_byte_data(client, regs[i], regs[i + 1]);
		if (ret < 0)
			return ret;
	}
	return 0;
}

static int read_reg(struct i2c_client *client, u8 reg, u8 channel)
{
	return i2c_smbus_read_byte_data(client, (reg) | (channel << 6));
}

static int tw8836_initial_hw(struct i2c_client *client, unsigned char *regs)
{
	write_regs(client, tw8836_lvds_to_bt656, sizeof(tw8836_lvds_to_bt656));
	return 0;
}

static long tw8836_ioctl(struct file *filp, unsigned int cmd,
		unsigned long arg)
{

//	switch (cmd) {
//		case LED_ON:
//		case LED_OFF:
//			if (arg > LED_NUM) {
//				return -EINVAL;
//			}
//
//			gpiod_set_value(led_gpio.gpiod[arg], !cmd);
//			//pr_info(DEVICE_NAME": %d %d\n", arg, cmd);
//			break;
//
//		default:
//			return -EINVAL;
//	}

	return 0;
}

static struct file_operations tw8836_fops = {
	.owner			= THIS_MODULE,
	.unlocked_ioctl	= tw8836_ioctl,
};


static struct miscdevice tw8836_dev = {
	.minor			= MISC_DYNAMIC_MINOR,
	.name			= DEVICE_NAME,
	.fops			= &tw8836_fops,
};

static int TW8836_probe(struct i2c_client *client,
			    const struct i2c_device_id *id)
{
	/* struct i2c_adapter *adapter = client->adapter; */
	struct class *dev_class;
	int ret;
	dev_t devt;

	dev_info(&client->dev, "chip found @ 0x%02x (%s)\n",
			client->addr << 1, client->adapter->name);

	ret = misc_register(&tw8836_dev);
	if (ret != 0)
		goto out;

	tw8836_initial_hw(client, tw8836_lvds_to_bt656);

	return 0;

out:
	return -EINVAL;
}

static int TW8836_remove(struct i2c_client *client)
{
	misc_deregister(&tw8836_dev);
	return 0;
}

static const struct i2c_device_id TW8836_id[] = {
	{ "TW8836", 0 },
	{ }
};
MODULE_DEVICE_TABLE(i2c, TW8836_id);

static struct i2c_driver TW8836_driver = {
	.driver = {
		.name	= "TW8836",
	},
	.probe		= TW8836_probe,
	.remove		= TW8836_remove,
	.id_table	= TW8836_id,
};

module_i2c_driver(TW8836_driver);

MODULE_LICENSE("GPL v2");
MODULE_DESCRIPTION("TW8836 V4L2 i2c driver");
MODULE_AUTHOR("Slash.huang@regulus.com.tw");
